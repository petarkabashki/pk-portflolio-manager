âŸ¨FromTSâ‡FromTimestamp, ToTSâ‡ToTimestampâŸ© â† â€¢Import "bqn-libs/datetime.bqn"
âŸ¨JParseâ‡ParseâŸ© â† â€¢Import "bqn-libs/json.bqn"
csvâ†â€¢Import "bqn-libs/csv.bqn"
strâ†â€¢Import "bqn-libs/strings.bqn"
ToUpper â† -âŸœ(32Ã—1="a{"âŠ¸â‹)
RowNu â† { ((â†•â‰ ğ•©)-ğ•¨) âˆ¾Ë˜ ğ•©}
SplitNum â†â€¢Parsefloatâ€¿âŠ¢{ğ• ğ•©}Â¨(("-."âˆ¾'0' + â†•10) (((âŠ¢â‹ˆÂ¬)âˆ˜âˆŠËœ)/Â¨(<âŠ¢)) âŠ¢)
NFmt â† âŸ¨"Â¯"âŸ©â€¿âŸ¨"-"âŸ©âŠ¸str.ReplaceAll âˆ˜ â€¢Fmt
ParseDT â† (âˆ¾âŸœ0â€¿0 4âŠ¸â†‘) (str.ToNums  âŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll) 
ParseTS â† FromTS ParseDT
((â†•â‰ )â‰âŠ¢)âˆ˜âŠ‘ tnhâ€¿tnd â† âŠ¢â€¿>{ğ•ğ•©}Â¨ 1(âŠ‘âˆ˜â†‘â‹ˆâ†“) csv.SplitL â€¢FLines "transactions.csv"
3â†‘ trans â† ((â‹(ParseTSÂ¨ 1âŠ¸âŠË˜))âŠ¸âŠ) âˆ¾Ë˜Â´{â‰âŠ¢â€¿âŠ¢â€¿â€¢ParseFloatâ€¿âŠ¢â€¿âŠ¢{ğ•ğ•©}Â¨â‰ğ•©}â€¿{â€¢ParseFloatÂ¨ğ•©} {ğ• ğ•©}Â¨ 5 (â†‘Ë˜â‹ˆâ†“Ë˜) tnd
IfElse â† {condâ€¿Trueâ€¿False: condâ—¶Falseâ€¿True @}

CalcBalances â† { trans â† ğ•©
	2â†‘ flows â† âˆ¾Â´ âŸ¨3,7,1âŸ©â€¿âŸ¨4,8,Â¯1âŸ© {aâ€¿qâ€¿mâ†ğ•¨â‹„ (3âŠ¸â†‘Ë˜âˆ¾Ë˜aâŠ¸âŠË˜âˆ¾Ë˜(mâŠ¸Ã— 2âŠ¸âŠË˜Ã—qâŠ¸âŠË˜)) ğ•©}Â¨ <trans
	assets â† â·3âŠË˜flows
	3â†‘Â¨ assets { csv.JoinL â‰âŠ¢â€¿âŠ¢â€¿NFmtâ€¿âŠ¢â€¿NFmtâ€¿NFmt {ğ• ğ•© }Â¨ â‰(âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) ğ•©}Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”âŠ¢)  flows
	assets { ("reports/flows/"âˆ¾ğ•¨ âˆ¾ ".csv" ) â€¢FLines (<"xchg,dt,side,asset,qty,cum") âˆ¾ csv.JoinL â‰âŠ¢â€¿âŠ¢â€¿NFmtâ€¿âŠ¢â€¿NFmtâ€¿NFmt {ğ• ğ•© }Â¨ â‰(âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) ğ•©}Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”âŠ¢)  flows

	abals â† assets â‰Ë˜  +Â´Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”Â¯1âŠ¸âŠË˜)  flows
	"balances.csv" â€¢FLines csv.JoinL âˆ¾Ë˜Â´ âŠ¢â€¿NFmt {ğ•Â¨ğ•©}Â¨ 1 (â†‘Ë˜â‹ˆâ†“Ë˜) (â‹âŠË˜)âŠ¸âŠ abals
	abals
}
bals â† CalcBalances trans
### Bags & PNLs
2â†‘ flows â† âˆ¾Â´ âŸ¨3,7,1âŸ©â€¿âŸ¨4,8,Â¯1âŸ© {aâ€¿qâ€¿mâ†ğ•¨â‹„ (2âŠ¸â†‘Ë˜âˆ¾Ë˜ (mÃ—2âŠ¸âŠË˜) âˆ¾Ë˜ aâŠ¸âŠË˜âˆ¾Ë˜(qâŠ¸âŠË˜)âˆ¾Ë˜9â€¿10â€¿11âŠ¸âŠË˜) ğ•©}Â¨ <trans
#15â†‘ (3âŠ¸âŠË˜) flows
#15â†‘ ((("USDT")âŠ¸â‰¡Â¨ 3âŠ¸âŠË˜)âŠ¸/) flows
assets â† â·3âŠË˜flows
#âŠ‘assets âŠ< "USDT"
#23âŠ‘assets
5â†‘ âŠ‘ grtr â† ((âŠ3âŠ¸âŠË˜)âŠ”âŠ¢)  flows
CalcPnl â† {
	>(<0â€¿0â€¿0) {
		rbâ€¿rqâ€¿rpnl â† ğ•¨   â‹„ sdâ€¿tbâ€¿tq â† ğ•©
		IfElse (sdâ‰¡1)â€¿{ğ•¤
			(rb+tb)â€¿(rq+tq)â€¿0
		}â€¿{ğ•¤
			tpâ†tqÃ·tb â‹„ 
			#rp â† IfElse (rbâ‰¡0)â€¿{0}â€¿{(rqÃ·rb)} â‹„ 
			rp â† {rqÃ·rb} â‹„ 
			nbâ†(rb-tb) â‹„ nq â† nbÃ—rp â‹„ pnl â† tb Ã— tp - rp â‹„
			nbâ€¿nqâ€¿pnl
		}
	}` ğ•©  
}
#15â†‘   2â€¿4â€¿5âŠ¸âŠË˜ 23âŠ‘grtr
qquotes â† "usdt"â€¿"btc"â€¿"gbp"
3â†‘âŠ‘âŠ‘ pnls â† 5â€¿6â€¿7 {
	((âŠ¢âˆ¾Ë˜(+`Â¯1âŠ¸âŠË˜)) (CalcPnl(<Ë˜ 2â€¿4â€¿ğ•¨âŠ¸âŠË˜)))Â¨ ğ•©
}Â¨ <grtr

pnldirs â† {"reports/pnls-"âˆ¾ğ•©}Â¨ qquotes 
{{â€¢file.CreateDir ğ•©}âŸ(Â¬â€¢file.Exists) ğ•©}Â¨ pnldirs 
âŠ‘âŠ‘ pnldirs {dâ†ğ•¨â‹„  assets { (dâˆ¾"/"âˆ¾ğ•¨âˆ¾".csv") â€¢FLines (<"xch,dt,base,quote,pnl,cumPnl") âˆ¾ csv.JoinL ğ•©}Â¨ (2â†‘Ë˜Â¨grtr) âˆ¾Ë˜Â¨ NFmtÂ¨Â¨ ğ•© }Â¨ pnls
2â†‘âŠ‘bagsâ†((0â€¿1â€¿3âŠ¸âŠË˜(>Â¯1âŠ¸âŠÂ¨)))Â¨pnls
qquotes { ("bags-"âˆ¾ğ•¨âˆ¾".csv") â€¢FLines (<"asset,base,quote,pnl") âˆ¾ csv.JoinL ((â‹âŠË˜)âŠâŠ¢) assets âˆ¾Ë˜ NFmtÂ¨ ğ•©}Â¨ bags
# check bags and balances are the same to small rounding error
assets â‰¡ âŠË˜ bals
1eÂ¯8âŠ¸< +Â´Â¨ (<1âŠ¸âŠË˜bals) (|-)Â¨ âŠË˜Â¨bags
#3â†‘ âŠ‘ ParseTSÂ¨Â¨   (1âŠ¸âŠË˜)Â¨grtr
#â€¢math.isnaN
#13â†‘Â¨ (<ParseTSÂ¨Â¨1âŠ¸âŠË˜Â¨grtr) ((âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) (((â‹âŠ‘Ë˜)âŠ¸âŠ)(âˆ¾Â´âˆ¾Ë˜Â¨)))Â¨ 2âŠ¸âŠË˜Â¨Â¨ pnls


