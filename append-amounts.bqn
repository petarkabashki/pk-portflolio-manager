âŸ¨FromTSâ‡FromTimestamp, ToTSâ‡ToTimestampâŸ© â† â€¢Import "bqn-libs/datetime.bqn"
âŸ¨JParseâ‡ParseâŸ© â† â€¢Import "bqn-libs/json.bqn"
csvâ†â€¢Import "bqn-libs/csv.bqn"
strâ†â€¢Import "bqn-libs/strings.bqn"
ToUpper â† -âŸœ(32Ã—1="a{"âŠ¸â‹)
RowNu â† { ((â†•â‰ ğ•©)-ğ•¨) âˆ¾Ë˜ ğ•©}
SplitNum â†â€¢Parsefloatâ€¿âŠ¢{ğ• ğ•©}Â¨(("-."âˆ¾'0' + â†•10) (((âŠ¢â‹ˆÂ¬)âˆ˜âˆŠËœ)/Â¨(<âŠ¢)) âŠ¢)


NFmt â† âŸ¨"Â¯"âŸ©â€¿âŸ¨"-"âŸ©âŠ¸str.ReplaceAll âˆ˜ â€¢Fmt

FillMissing â† { 
	tsâ€¿pâ† <Ë˜â‰0â€¿Â¯1âŠ¸âŠË˜ğ•©
	ttake â† (âˆ¾âŸœ1âˆ˜Ã·âŸœğ•¨âˆ˜(1âŠ¸â†“-âŸœÂ»))ts 
	(âˆ¾Â´(ts) + ğ•¨ Ã— â†•Â¨ ttake) â‰Ë˜ (ttake / p)
} 

# Function to loading quote candlesticks except USDT
LoadQ â† { lquotes â† ğ•©
	qfilesâ† (âŠ¢âˆ¾âŸœ"_USDT-1h.json")Â¨ (<"/media/mu6mula/Data/Crypto-Data-Feed/freq-user-data/data/binance/") âˆ¾Â¨ lquotes
	#â€¢Show lquotes
	#â€¢Show qfiles
	qticks â† (((Ã·âŸœ1000âˆ˜âŠË˜) âˆ¾Ë˜ ((+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))âˆ˜>âˆ˜JParseâˆ˜â€¢FChars)Â¨ qfiles
	gbp â† ((FromTSÂ¨âŠË˜)âˆ¾Ë˜( (+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))  ((âˆ¾âŸœ0âˆ˜(str.ToNumsâŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll)Â¨âˆ˜âŠË˜)âˆ¾Ë˜(â€¢ParseFloatÂ¨Ë˜ (Â¯1â†“Ë˜1âŠ¸â†“Ë˜)))>Â¯1â†“76000â†“csv.Splitâ€¢FChars"GBPUSD60.csv"
	3â†‘Â¨ qgticks â†  qticks  âˆ¾ <gbp
	lgquotes â† lquotesâˆ¾<"GBP"
	lgquotesâ€¿qgticks
}
LoadTradesâ† {ğ•Šâ‹„â‰ âŠ¢â€¿âŠ¢â€¿â€¢ParseFloatâ€¿âŠ¢â€¿âŠ¢â€¿â€¢ParseFloatâ€¿â€¢ParseFloat {ğ• ğ•©}Â¨  â‰ >csv.SplitL â€¢FLines "trades.csv"}
#3â†‘ tradesâ† LoadTrades 0
AddQuoteUSDT â† {
	trans â† ğ•©
	# convert DAI USDC BUSD to USDT
	qquotesâ† â·cquote â† â¥Š((Â¬âˆŠâŸœ"DAI"â€¿"USDC"â€¿"BUSD"â€¿"USD") âŠË˜ ((<"USDT")âŠ¸âˆ¾Ë˜)) â¥ŠË˜4âŠË˜ trans
	# get unix timstamp and array datetime of transactions, truncated to hours
	10â†‘ httsâ† FromTSÂ¨ hdtsâ† (âˆ¾âŸœ0â€¿0 4âŠ¸â†‘)Â¨ dtsâ† (str.ToNums  âŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll)Â¨ 1âŠË˜ trans
	lquotes â† ((Â¬âˆŠâŸœ"GBP"â€¿"USDT")âŠ¸/) qquotes
	âŠ‘ gquotesâ€¿gticks â† LoadQ lquotes
	usmaskâ†(âˆŠâŸœâŸ¨"USDT"âŸ©) qquotes 
	nuquotes â† (Â¬usmask)/ qquotes 
	>1â†‘Â¨orticks â† (gquotes âŠ nuquotes) âŠ 3600âŠ¸FillMissingÂ¨ gticks 
	# group timestamps by quote unit
	qquotesâ‰â‰¢Â¨gtrts â† ((âŠcquote)âŠ”htts) 
	### check for missing quote tickers
	+Â´Â¨ (âŠË˜Â¨orticks) (Â¬âŠ¢âˆŠâŠ£)Â¨ (Â¬usmask) / gtrts
	+Â´Â¨ orticks ( ( (âŠË˜âŠ£)âŠâŠ¢) â‰¥ (â‰ âŠ£))Â¨ (Â¬usmask)/gtrts

	## Ticker quote price in USDT per transaction (grouped by cquotes)
	2â†‘Â¨ gusdp â† (orticks (((âŠË˜âŠ£)âŠâŠ¢)âŠ(1âŠ¸âŠË˜âŠ£))Â¨(Â¬usmask)/gtrts) âˆ¾ <((â‰ (âŠ‘/usmask)âŠ‘gtrts)â¥Š1)
	itrans â† (qquotes âŠ (âˆ¾âŸœ(<"USDT")) âŠ¢ (Â¬usmask) / qquotes) 

	# match quote ticker with transactions, grouped  by quote unit; flatten afterwards
	# append quoteusdt price as last column
	#traqusdt â† âˆ¾Â´ gusdp (âˆ¾ËœË˜)Â¨ itrans âŠ (grtrans â† (âŠcquote)âŠ”trans)
	traqusdt â† âˆ¾Â´Â¨ gusdp â‹ˆ itrans âŠ (grtrans â† (âŠcquote)âŠ”trans)
}
3â†‘Â¨ usdtQPâ€¿trades â† AddQuoteUSDT LoadTrades 0

btcf â† âˆ¾âŸœ("_USDT-1h.json") ("/media/mu6mula/Data/Crypto-Data-Feed/freq-user-data/data/binance/") âˆ¾ "BTC"
2â†‘ btcTicks â† (((Ã·âŸœ1000âˆ˜âŠË˜) âˆ¾Ë˜ ((+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))âˆ˜>âˆ˜JParseâˆ˜â€¢FChars) btcf

# transaction timestamps in Unix and array formats
3â†‘ httsâ† FromTSÂ¨ hdtsâ† (âˆ¾âŸœ0â€¿0 4âŠ¸â†‘)Â¨ dtsâ† (str.ToNums  âŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll)Â¨ 1âŠË˜ trades
# check for missing ticker 
+Â´ (htts) (Â¬âˆŠ) âŠ‘Ë˜ 3600âŠ¸FillMissing btcTicks
#traqusdt /Ëœ (htts) (Â¬âˆŠ) âŠ‘Ë˜ btcTicks

3â†‘ btcP â† htts ((âŠ£âŠËœ(âŠ‘Ë˜âŠ¢))âŠ(1âŠ¸âŠ‘Ë˜âŠ¢)) 3600âŠ¸FillMissing btcTicks

2â†‘gbpTicks â† ((FromTSÂ¨âŠË˜)âˆ¾Ë˜( (+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))  ((âˆ¾âŸœ0âˆ˜(str.ToNumsâŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll)Â¨âˆ˜âŠË˜)âˆ¾Ë˜(â€¢ParseFloatÂ¨Ë˜ (Â¯1â†“Ë˜1âŠ¸â†“Ë˜)))>Â¯1â†“76000â†“csv.Splitâ€¢FChars"GBPUSD60.csv"
3â†‘ gbpP â† htts ((âŠ£âŠËœ(âŠ‘Ë˜âŠ¢))âŠ(1âŠ¸âŠ‘Ë˜âŠ¢)) 3600âŠ¸FillMissing gbpTicks
	# take base and quote amounts according to side flipping received and spent accordingly
Â¯3â†‘Â¨ bamntâ€¿qamnt â† <Ë˜â‰ ((1âŠ¸â‰¢Â¨ 2âŠ¸âŠË˜) âŒ½Ë˜ (Â¯2âŠ¸â†‘Ë˜)) trades
# calculate transaction price in usdt, btc, gbp
3â†‘Â¨ abtcâ€¿agbp â† btcPâ€¿gbpP Ã·ËœÂ¨ <ausdt â† usdtQP Ã— qamnt 
3â†‘trans â† trades âˆ¾Ë˜ bamnt âˆ¾Ë˜ qamnt âˆ¾Ë˜ ausdt âˆ¾Ë˜ abtc âˆ¾Ë˜ agbp
htrans â† "exchange"â€¿"time"â€¿"side"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent"â€¿"baseAmt"â€¿"quoteAmt"â€¿"usdt"â€¿"btc"â€¿"gbp"
"transactions.csv" â€¢FLines csv.JoinL htrans âˆ¾ ({â‰âŠ¢â€¿âŠ¢â€¿NFmtâ€¿âŠ¢â€¿âŠ¢{ğ•ğ•©}Â¨â‰5â†‘Ë˜ğ•©}âˆ¾Ë˜{NFmtÂ¨5â†“Ë˜ğ•©}) trans


## Totals and bags
## Calculate totals by asset
#15â†‘ inFlows â† (2â†‘Ë˜ trans) âˆ¾Ë˜ 1 âˆ¾Ë˜ ((1â‰¢Â¨2âŠË˜trans) âŠ‘Â¨ <Ë˜â‰3â€¿4 âŠ â‰trans) âˆ¾Ë˜ 5âŠË˜trans
#15â†‘ outFlows â† (2â†‘Ë˜ trans) âˆ¾Ë˜ Â¯1 âˆ¾Ë˜ ((1â‰¡Â¨2âŠË˜trans) âŠ‘Â¨ <Ë˜â‰3â€¿4 âŠ â‰trans) âˆ¾Ë˜ -6âŠË˜trans
#15â†‘ inOutFlows â† inFlows âˆ¾ outFlows
#â‰¢inOutFlows
#3â†‘ assetsH â† â· 3âŠË˜ inOutFlows 
#iassets â† â‹assetsH
#assets â† iassets âŠ assetsH
#assets (âŠ‘âŠ’) <"BTC"
#5â†‘ 12âŠ‘ aflows â†  ((â‹1âŠ¸âŠË˜)âŠâŠ¢)Â¨ iassets âŠ (âŠ(3âŠ¸âŠ)Ë˜)âŠ¸âŠ” inOutFlows 
#5â†‘ 10600â†“ 12âŠ‘ (âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜))Â¨ aflows
##>3â†‘ 13â†‘Â¨ sigFlows â† ( (Ã—Â´Â¨ <Ë˜))Â¨ (2â€¿4âŠ¸âŠË˜)Â¨ aflows 
##1âŠ¸âŠÂ¨aflows
#   13â†‘ finalAmounts â† (+Â´ Â¯1âŠ¸âŠË˜) Â¨ aflows 
##>3â†‘ 9â†‘Â¨ cumFlows â†  +`Â¨ sigFlows 
## 12âŠ‘ aflows âˆ¾Ë˜Â¨ cumFlows
# assets âˆ¾Ë˜ finalAmounts
# 
#(<Â¯2âŠ¸â†‘)Ë˜ trans
#
#
#
# csv.Join 3â†‘ trans
