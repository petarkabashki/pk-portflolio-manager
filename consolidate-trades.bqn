

âŸ¨CsvSplitâ‡Split,Join,CsvSplitLâ‡SplitL,JoinLâŸ©â†â€¢Import "bqn-libs/csv.bqn"
âŸ¨StrSplitâ‡SplitâŸ©â†â€¢Import "bqn-libs/strings.bqn"
ToUpper â† -âŸœ(32Ã—1="a{"âŠ¸â‹)
RowNu â† { ((â†•â‰ ğ•©)-ğ•¨) âˆ¾Ë˜ ğ•©}
##########################################
# Phemex
# TODO: Include fees in qty / total and add fee/feeAss columns

PhemTraâ† { ğ•¤
	filesâ†(<"../trading-data/phemex/") âˆ¾Â¨ "SPOT_TRADE_2023"â€¿"SPOT_TRADE_2024-interim" âˆ¾Â¨ (<".csv")
	dataâ† >âˆ¾Â´(1âŠ¸â†“ >CsvSplitL  â€¢FLines)Â¨  files

	sideâ† ToUpperÂ¨ 2âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	baseâ€¿quote â† <Ë˜â‰> " / "âŠ¸StrSplitÂ¨ 1âŠË˜data
	xpriceâ†â€¢ParseFloatÂ¨ 4âŠË˜data
	amrecQâ€¿amrecA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 3âŠË˜data
	amspeQâ€¿amspeA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 5âŠË˜data
	amQâ€¿amA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 6âŠË˜data
	#amrecQ
	#amspeQ
	#7 â†‘ â‰amrecQ â‰ amspeQ
	 idxbuy â† (iside â‰¡Â¨ 1)
	 qtyâ† (1-idxbuy) âŠ‘Â¨ <Ë˜â‰amrecQ â‰ amspeQ
	 totalâ† (idxbuy) âŠ‘Â¨ <Ë˜â‰amrecQ â‰ amspeQ
	#10â†‘ (<Ë˜â‰>(âŠ¢â‹ˆ(1âŠ¸-)) (iside â‰¢Â¨ Â¯1)) âŠÂ¨ <â‰amrecQ â‰ amspeQ
	#feeQâ€¿feeA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 9âŠË˜data
	# checks
	#+Â´(xprice â‹† iside) - amspeQ Ã· amrecQ
	#+Â´ (iside = 1) âˆ§ (amrecA â‰¢Â¨ base) âˆ¨ (amspeA â‰¢Â¨ quote)
	#+Â´ (iside = Â¯1) âˆ§ (amspeA â‰¢Â¨ base) âˆ¨ (amrecA â‰¢Â¨ quote)
	("ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"qty"â€¿"total") âˆ¾ â‰[(âŠË˜ data), iside, base, quote, qty, total]
}

#PhemTra 0 


##########################################
# Binance
# TODO: Download 2024 spot order history and include in the calculations`

# Replace with SpotOrder logs and include transactions
#BinaTraOrderHistâ† { ğ•¤
#	filesâ†(<"../trading-data/binance/OrderHistory/") âˆ¾Â¨ "2024-02-22 19_27_28"â€¿"2023"â€¿"2022"â€¿"2021"â€¿"2020" âˆ¾Â¨ (<".csv")
#	#dataâ† âŸ¨ 1, 10, 697, 698, 1398, 1605, 1606, 1752, 1855, 1859, 1869, 1870 âŸ© âŠ >âˆ¾Â´(1âŠ¸â†“ >CsvSplitL  â€¢FLines)Â¨  files
#	dataâ† >âˆ¾Â´(1âŠ¸â†“ >CsvSplitL  â€¢FLines)Â¨  files
#
#	sideâ† ToUpperÂ¨ 4âŠË˜data
#	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
#	qassetsâ†"BTC"â€¿"USDT"â€¿"BUSD"â€¿"GBP"â€¿"USDC"â€¿"UST"â€¿"DAI"â€¿"ETH"
#	qassets âˆ¾ â‰ qassets (+Â´âˆ˜/âˆ˜â·)âŒœ 10â†‘ 2 âŠË˜ data
##10â†‘ data
#	 pairs â† 2 âŠË˜ data
#	 tqposâ† â‰ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ pairs
#	 qpos â† âŒˆËË˜ tqpos 
##	â‰¢data 
##(/qpos â‰¡Â¨0)
#	 (/qpos â‰¡Â¨0) âŠ data
#	 quoteâ† â¥Š((/âŸœqassets)Ë˜(0âŠ¸â‰¢)Â¨) tqpos 
#	 base â† qpos	â†‘Â¨ pairs
#	  execcol â† 8âŠË˜data
#	  trtotcol â† 10âŠË˜data
#	 avgprice â† â€¢ParseFloatÂ¨ 9âŠË˜data
#	 # Check base is always in the "Executed" column
#	 +Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ base â·Â¨ execcol
#	 # Check quote is always in the "Trading total" column
#	 +Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ quote â·Â¨ trtotcol
#	 totalâ† â€¢ParseFloatÂ¨ (-â‰ Â¨quote) â†“Â¨ trtotcol
#
#	 
#	 executed â† â€¢ParseFloatÂ¨ (-qpos) â†“Â¨ execcol
#		+Â´avgprice - total Ã· executed + 1eÂ¯18
#		+Â´0â‰¢Â¨executed
#	("ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"qty"â€¿"total") âˆ¾ (executed â‰¢Â¨1) / â‰[(7âŠË˜ data), iside, base, quote, executed, total]
#}

BinaTraâ† { ğ•¤
	filesâ†(<"../trading-data/binance/SpotOrder/") âˆ¾Â¨ "2023"â€¿"2022"â€¿"2021"â€¿"2020" âˆ¾Â¨ (<".csv")
	dataâ† >âˆ¾Â´(1âŠ¸â†“ >CsvSplitL  â€¢FLines)Â¨  files

	sideâ† ToUpperÂ¨ 2âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	qassetsâ†"BTC"â€¿"USDT"â€¿"BUSD"â€¿"GBP"â€¿"USDC"â€¿"UST"â€¿"DAI"â€¿"ETH"
	#qassets âˆ¾ â‰ qassets (+Â´âˆ˜/âˆ˜â·)âŒœ 10â†‘ 2 âŠË˜ data
	#10â†‘ data
	pairs â† 1 âŠË˜ data
	tqposâ† â‰ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ pairs
	qpos â† âŒˆËË˜ tqpos 
	#	â‰¢data 
	#(/qpos â‰¡Â¨0)
	#(/qpos â‰¡Â¨0) âŠ data
	quoteâ† â¥Š((/âŸœqassets)Ë˜(0âŠ¸â‰¢)Â¨) tqpos 
	base â† qpos	â†‘Â¨ pairs
	tscol â† âŠË˜data
	execcol â† 4âŠË˜data
	amountcol â† 5âŠË˜data
	feecol â† 6âŠË˜data
	#('A'+â†•'Z'-'A')  
	#price â† â€¢ParseFloatÂ¨ 3âŠË˜data
	# Check base is always in the "Executed" column
	+Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ base â·Â¨ execcol
	# Check quote is always in the "Trading total" column
	+Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ quote â·Â¨ amountcol

	#feeAssetâ†(isideâ‰¢Â¨1) âŠ‘Â¨ <Ë˜â‰baseâ‰quote
	#feeQâ€¿feeAss â† { posâ† (âŠ‘/)Â¨ ğ•© âˆŠÂ¨ <('A'+â†•'Z'-'A')â‹„ <Ë˜â‰> pos (â†‘â‹ˆâ†“)Â¨ğ•©} ( 6 âŠ â‰ (1âŠ¸â‰¢Â¨ Â¯1âŠ¸âŠ‘Â¨ feeAsset â·Â¨ feecol) / data) 
	feeâ€¿feeAssâ† { posâ† (âŠ‘/)Â¨ ğ•© âˆŠÂ¨ <('A'+â†•1+'Z'-'A')â‹„ âŸ¨â€¢ParseFloatÂ¨, âŠ¢âŸ© {ğ•  ğ•©}Â¨<Ë˜â‰>  pos (â†‘â‹ˆâ†“)Â¨ğ•©} ( 6 âŠ â‰ data) 
	# (feeAss â‰¢Â¨ feeAsset) / â‰feeAssetâ‰feeAss 
	#feeAssetâˆ¾isideâˆ¾baseâ‰quote
	amount â† â€¢ParseFloatÂ¨ (-â‰ Â¨quote) â†“Â¨ amountcol
	executed â† â€¢ParseFloatÂ¨ (-qpos) â†“Â¨ execcol
	### Include fee in qty / total for buy / sell
	total â† amount - fee Ã— iside â‰¡Â¨ Â¯1 
	qty â† executed - fee Ã— iside â‰¡Â¨ 1 
	#	+Â´avgprice - total Ã· executed + 1eÂ¯18
	#	+Â´0â‰¢Â¨executed
	########################
	### Fee is not included in the total, needs to be subtracted from the received amount or applied otherwise
	 ("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"qty"â€¿"total"â€¿"fee"â€¿"feeAss") âˆ¾ (<"binance") âˆ¾Ë˜ â‰[tscol, iside, base, quote, qty, total, fee, feeAss]
}
 5â†‘BinaTra 0

#############################################
#  Coinbase
#############################################
#  Kucoin
#############################################
#  BitGet
#############################################
#  Kraken

1 RowNu â‰ qassets âˆ¾Ë˜ ((0âŠ¸â‰¢))Â¨ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ 10â†‘ 2 âŠË˜ data
 â‰ <Ë˜â‰((0âŠ¸â‰¢))Â¨ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ 10â†‘ 2 âŠË˜ data
(Â¯1âŠ¸âŠ‘ Ã— âŠ¢) âŸ¨0,0,0,1,0âŸ©
0 RowNu â‰ 	qassets (â·)âŒœ 10â†‘ 2 âŠË˜ data
	5 âŠdata
	baseâ€¿quote â† <Ë˜â‰> " / "âŠ¸StrSplitÂ¨ 1âŠË˜data
	xpriceâ†â€¢ParseFloatÂ¨ 4âŠË˜data
	amrecQâ€¿amrecA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 3âŠË˜data
	amspeQâ€¿amspeA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 5âŠË˜data
	amQâ€¿amA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 6âŠË˜data
	#feeQâ€¿feeA â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 9âŠË˜data
	# checks
	#+Â´(xprice â‹† iside) - amspeQ Ã· amrecQ
	#+Â´ (iside = 1) âˆ§ (amrecA â‰¢Â¨ base) âˆ¨ (amspeA â‰¢Â¨ quote)
	#+Â´ (iside = Â¯1) âˆ§ (amspeA â‰¢Â¨ base) âˆ¨ (amrecA â‰¢Â¨ quote)
	("ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"amrec"â€¿"amspe") âˆ¾ â‰[(âŠË˜ data), iside, base, quote, amrecQ, amspeQ]
}

#PhemTra 0 

b

fdâ†  â‰â‰âŒ½ â‰ Â¨ Split â€¢FChars âŠ‘ ph_files
fdâ†  â‰â‰ (1âŠ¸â†“-Â¯1âŠ¸â†“) â‰ Â¨ Split â€¢FChars âŠ‘ ph_files

â†>JParse â€¢FChars dfldâˆ¾"ALGO_USDT-8h.json" 
3 + 3

