âŸ¨FromTSâ‡FromTimestamp, ToTSâ‡ToTimestampâŸ© â† â€¢Import "bqn-libs/datetime.bqn"
âŸ¨JParseâ‡ParseâŸ© â† â€¢Import "bqn-libs/json.bqn"
csvâ†â€¢Import "bqn-libs/csv.bqn"
strâ†â€¢Import "bqn-libs/strings.bqn"
ToUpper â† -âŸœ(32Ã—1="a{"âŠ¸â‹)
RowNu â† { ((â†•â‰ ğ•©)-ğ•¨) âˆ¾Ë˜ ğ•©}
SplitNum â†â€¢Parsefloatâ€¿âŠ¢{ğ• ğ•©}Â¨(("-."âˆ¾'0' + â†•10) (((âŠ¢â‹ˆÂ¬)âˆ˜âˆŠËœ)/Â¨(<âŠ¢)) âŠ¢)
NFmt â† âŸ¨"Â¯"âŸ©â€¿âŸ¨"-"âŸ©âŠ¸str.ReplaceAll âˆ˜ â€¢Fmt
ParseDT â† (âˆ¾âŸœ0â€¿0 4âŠ¸â†‘) (str.ToNums  âŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸str.ReplaceAll) 
ParseTS â† FromTS ParseDT
((â†•â‰ )â‰âŠ¢)âˆ˜âŠ‘ tnhâ€¿tnd â† âŠ¢â€¿>{ğ•ğ•©}Â¨ 1(âŠ‘âˆ˜â†‘â‹ˆâ†“) csv.SplitL â€¢FLines "transactions.csv"
3â†‘ (â‹(ParseTSÂ¨ 1âŠ¸âŠË˜)) tnd
3â†‘ trans â† ((â‹(ParseTSÂ¨ 1âŠ¸âŠË˜))âŠ¸âŠ) âˆ¾Ë˜Â´{â‰âŠ¢â€¿âŠ¢â€¿â€¢ParseFloatâ€¿âŠ¢â€¿âŠ¢{ğ•ğ•©}Â¨â‰ğ•©}â€¿{â€¢ParseFloatÂ¨ğ•©} {ğ• ğ•©}Â¨ 5 (â†‘Ë˜â‹ˆâ†“Ë˜) tnd

CalcBalances â† { trans â† ğ•©
	2â†‘ flows â† âˆ¾Â´ âŸ¨3,7,1âŸ©â€¿âŸ¨4,8,Â¯1âŸ© {aâ€¿qâ€¿mâ†ğ•¨â‹„ (3âŠ¸â†‘Ë˜âˆ¾Ë˜aâŠ¸âŠË˜âˆ¾Ë˜(mâŠ¸Ã— 2âŠ¸âŠË˜Ã—qâŠ¸âŠË˜)) ğ•©}Â¨ <trans
	assets â† â·3âŠË˜flows
	#3â†‘Â¨ 4 (â†‘Ë˜â‹ˆâ†“Ë˜) (âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) âŠ‘ ((âŠ2âŠ¸âŠË˜)âŠ”âŠ¢)  flows
	3â†‘Â¨ assets { csv.JoinL â‰âŠ¢â€¿âŠ¢â€¿NFmtâ€¿âŠ¢â€¿NFmtâ€¿NFmt {ğ• ğ•© }Â¨ â‰(âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) ğ•©}Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”âŠ¢)  flows
	assets { ("reports/flows/"âˆ¾ğ•¨ âˆ¾ ".csv" ) â€¢FLines (<"xchg,dt,side,asset,qty,cum") âˆ¾ csv.JoinL â‰âŠ¢â€¿âŠ¢â€¿NFmtâ€¿âŠ¢â€¿NFmtâ€¿NFmt {ğ• ğ•© }Â¨ â‰(âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜)) ğ•©}Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”âŠ¢)  flows

	abals â† (â‹âŠË˜)âŠ¸âŠ assets â‰Ë˜ +Â´Â¨ ((âŠ3âŠ¸âŠË˜)âŠ”Â¯1âŠ¸âŠË˜)  flows
}
"balances.csv" â€¢FLines csv.JoinL âˆ¾Ë˜Â´ âŠ¢â€¿NFmt {ğ•Â¨ğ•©}Â¨ 1 (â†‘Ë˜â‹ˆâ†“Ë˜) CalcBalances trans



