
âŸ¨FromTSâ‡FromTimestamp, ToTSâ‡ToTimestampâŸ© â† â€¢Import "bqn-libs/datetime.bqn"
âŸ¨JParseâ‡ParseâŸ© â† â€¢Import "bqn-libs/json.bqn"
csvâ†â€¢Import "bqn-libs/csv.bqn"
âŸ¨ToNums, ReplaceAll, StrSplitâ‡SplitâŸ©â†â€¢Import "bqn-libs/strings.bqn"
ToUpper â† -âŸœ(32Ã—1="a{"âŠ¸â‹)
RowNu â† { ((â†•â‰ ğ•©)-ğ•¨) âˆ¾Ë˜ ğ•©}
SplitNum â†â€¢Parsefloatâ€¿âŠ¢{ğ• ğ•©}Â¨(("-."âˆ¾'0' + â†•10) (((âŠ¢â‹ˆÂ¬)âˆ˜âˆŠËœ)/Â¨(<âŠ¢)) âŠ¢)
##########################################
# Phemex
# TODO: Incorporate fees in received/spent if appropriate

PhemexTraâ† { ğ•¤
	filesâ†(<"../trading-data/phemex/") âˆ¾Â¨ "SPOT_TRADE_2023"â€¿"SPOT_TRADE_2024-interim" âˆ¾Â¨ (<".csv")
	dataâ† >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
	tscol â† âŠË˜ data
	sideâ† ToUpperÂ¨ 2âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	baseâ€¿quote â† <Ë˜â‰> " / "âŠ¸StrSplitÂ¨ 1âŠË˜data
	xpriceâ†â€¢ParseFloatÂ¨ 4âŠË˜data
	receivedâ€¿receivedU â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 3âŠË˜data
	spentâ€¿spentU â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 5âŠË˜data
	#feeâ€¿feeU â†((â€¢ParseFloatÂ¨âˆ˜âŠ)â‹ˆ(1âŠ¸âŠ)) â‰>" "âŠ¸StrSplitÂ¨ 9âŠË˜data
	("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent") âˆ¾ (<"phemex") âˆ¾Ë˜ â‰[tscol, iside, base, quote, received, spent]
}

#5â†‘PhemexTra 0 


##########################################
# Binance
# TODO: Download 2024 spot order history and include in the calculations`

# Replace with SpotOrder logs and include transactions
#BinaTraOrderHistâ† { ğ•¤
#	filesâ†(<"../trading-data/binance/OrderHistory/") âˆ¾Â¨ "2024-02-22 19_27_28"â€¿"2023"â€¿"2022"â€¿"2021"â€¿"2020" âˆ¾Â¨ (<".csv")
#	#dataâ† âŸ¨ 1, 10, 697, 698, 1398, 1605, 1606, 1752, 1855, 1859, 1869, 1870 âŸ© âŠ >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
#	dataâ† >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
#
#	sideâ† ToUpperÂ¨ 4âŠË˜data
#	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
#	qassetsâ†"BTC"â€¿"USDT"â€¿"BUSD"â€¿"GBP"â€¿"USDC"â€¿"UST"â€¿"DAI"â€¿"ETH"
#	qassets âˆ¾ â‰ qassets (+Â´âˆ˜/âˆ˜â·)âŒœ 10â†‘ 2 âŠË˜ data
##10â†‘ data
#	 pairs â† 2 âŠË˜ data
#	 tqposâ† â‰ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ pairs
#	 qpos â† âŒˆËË˜ tqpos 
##	â‰¢data 
##(/qpos â‰¡Â¨0)
#	 (/qpos â‰¡Â¨0) âŠ data
#	 quoteâ† â¥Š((/âŸœqassets)Ë˜(0âŠ¸â‰¢)Â¨) tqpos 
#	 base â† qpos	â†‘Â¨ pairs
#	  execcol â† 8âŠË˜data
#	  trtotcol â† 10âŠË˜data
#	 avgprice â† â€¢ParseFloatÂ¨ 9âŠË˜data
#	 # Check base is always in the "Executed" column
#	 +Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ base â·Â¨ execcol
#	 # Check quote is always in the "Trading total" column
#	 +Â´(1âŠ¸â‰¢âˆ˜Â¯1âŠ¸âŠ‘)Â¨ quote â·Â¨ trtotcol
#	 totalâ† â€¢ParseFloatÂ¨ (-â‰ Â¨quote) â†“Â¨ trtotcol
#
#	 
#	 executed â† â€¢ParseFloatÂ¨ (-qpos) â†“Â¨ execcol
#		+Â´avgprice - total Ã· executed + 1eÂ¯18
#		+Â´0â‰¢Â¨executed
#	("ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"qty"â€¿"total") âˆ¾ (executed â‰¢Â¨1) / â‰[(7âŠË˜ data), iside, base, quote, executed, total]
#}


BinanceTraâ† { ğ•¤
	filesâ†(<"../trading-data/binance/SpotOrder/") âˆ¾Â¨ "2023"â€¿"2022"â€¿"2021"â€¿"2020" âˆ¾Â¨ (<".csv")
	dataâ† >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
	sideâ† ToUpperÂ¨ 2âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	qassetsâ†"BTC"â€¿"USDT"â€¿"BUSD"â€¿"GBP"â€¿"USDC"â€¿"UST"â€¿"DAI"â€¿"ETH"
	pairs â† 1 âŠË˜ data
	tqposâ† â‰ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ pairs
	qpos â† âŒˆËË˜ tqpos 
	quoteâ† â¥Š((/âŸœqassets)Ë˜(0âŠ¸â‰¢)Â¨) tqpos 
	base â† qpos	â†‘Â¨ pairs
	tscol â† âŠË˜data
	execâ€¿execU â† <Ë˜â‰>SplitNumÂ¨ 4âŠË˜data
	amountâ€¿amountU â† <Ë˜â‰>SplitNumÂ¨ 5âŠË˜data
	feeâ€¿feeU â† <Ë˜â‰>SplitNumÂ¨ 6âŠË˜data
	# Check base unit == executed unit
	+Â´base â‰¢Â¨ execU
	# Check quote is always in the "Trading total" column
	+Â´quote â‰¢Â¨ amountU
	#iside âˆ¾ exec â‰ amount
	receivedâ€¿spent â† <Ë˜â‰>(isideâ‰¢Â¨1) âŒ½Â¨ <Ë˜â‰ exec â‰ amount
	### Include fee in qty / total for buy / sell
	#total â† amount - fee Ã— iside â‰¡Â¨ Â¯1 
	#qty â† executed - fee Ã— iside â‰¡Â¨ 1 
	########################
	### Fee is not included in the total, needs to be subtracted from the received amount or applied otherwise
	("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent") âˆ¾ (<"binance") âˆ¾Ë˜ â‰[tscol, iside, base, quote, received, spent]
}
#5â†‘BinanceTra 0

#############################################
#  Coinbase
CoinbaseProTraâ† { ğ•¤
	filesâ†(<"../trading-data/coinbase-pro/") âˆ¾Â¨ â¥Š (<"fills-2023-12-22") âˆ¾Â¨ (<".csv")
	dataâ† ((â‹4âŠ¸âŠË˜)âŠâŠ¢) >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
	tscol â† 4âŠË˜ data
	sideâ† ToUpperÂ¨ 3âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	baseâ€¿quote â† <Ë˜â‰> "-"âŠ¸StrSplitÂ¨ 2âŠË˜data
	# check side unit is either base or quote
	+Â´1â‰¢Â¨(âŠ‘âˆ˜â¥Š)Â¨ (<Â¨6âŠË˜data) âˆŠÂ¨ (<Ë˜â‰baseâ‰quote)
	# check fee/total unit is either base or quote
	+Â´1â‰¢Â¨(âŠ‘âˆ˜â¥Š)Â¨ (<Â¨10âŠË˜data) âˆŠÂ¨ (<Ë˜â‰baseâ‰quote)
	size â† â€¢ParseFloatÂ¨ 5âŠË˜data
	sizeU â† 6âŠË˜data
	total â† â€¢ParseFloatÂ¨ 9âŠË˜data
	totalU â† 10âŠË˜data
	priceâ†â€¢ParseFloatÂ¨ 7âŠË˜data
	calcTotal â† price Ã—Â¨ size
	indReceived â† (base â‰¡Â¨ totalU) â‰¡Â¨ (isideâ‰¡Â¨1) 
	indSpent â† 1 - indReceived
	size_tot â† <Ë˜â‰ size â‰ calcTotal 	
	received â† indReceived âŠ‘Â¨ size_tot 
	spent â† indSpent âŠ‘Â¨ size_tot
	#fee â† â€¢ParseFloatÂ¨ 8âŠË˜data
	#feeU â† totalU
	# check feeU == quote
	+Â´ totalU â‰¢Â¨ quote
	("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent") âˆ¾ (<"coinbase-pro") âˆ¾Ë˜ â‰[tscol, iside, base, quote, received, spent]
}
30â†“CoinbaseProTra 0 

#############################################
#  Kucoin
KucoinTraâ† { ğ•¤
	filesâ†(<"../trading-data/kucoin/Completed_Trades-") âˆ¾Â¨ ("2021"â€¿"2022") âˆ¾Â¨ (<".csv")
	dataâ† >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
	tscol â† 10âŠË˜ data
	sideâ† ToUpperÂ¨ 4âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	baseâ€¿quote â† <Ë˜â‰> "-"âŠ¸StrSplitÂ¨ 3âŠË˜data
	#fee â† â€¢ParseFloatÂ¨ 11âŠË˜data
	#feeUâ† ToUpperÂ¨ 13âŠË˜data
	# check fee unit is always the quote
	#+Â´feeU â‰¢Â¨ quote

	priceâ†â€¢parsefloatÂ¨ 6âŠË˜data
	amountâ†â€¢parsefloatÂ¨ 7âŠË˜data
	volumeâ†â€¢parsefloatÂ¨ 8âŠË˜data
	# check volume = price Ã— amount
	1eÂ¯6 < +Â´ | volume - price Ã— amount
  #iside âˆ¾ amount â‰ volume
	receivedâ€¿spent â† <Ë˜â‰>(iside â‰¢Â¨ 1) âŒ½Â¨ amount (<âˆ˜â‰)Ë˜ volume
	35â†“("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent") âˆ¾ (<"kucoin") âˆ¾Ë˜ â‰[tscol, iside, base, quote, received, spent]
}
#5â†‘ KucoinTra 0 

#############################################
#  BitGet
BitgetTraâ† { ğ•¤
	filesâ†(<"../trading-data/bitget/Spot Order History-") âˆ¾Â¨ ("2023"â€¿"2024-prelim") âˆ¾Â¨ (<".csv")
	# filter out cancelled
	dataâ† (((<"cancelled")â‰¢Â¨8âŠ¸âŠË˜) / âŠ¢) >âˆ¾Â´(1âŠ¸â†“ >csv.SplitL  â€¢FLines)Â¨  files
	tscol â† 0âŠË˜ data
	sideâ† ToUpperÂ¨ 3âŠË˜data
	isideâ† Â¯1+ 2Ã—side â‰¡Â¨ (<"BUY")
	qassetsâ†"BTC"â€¿"USDT"â€¿"BUSD"â€¿"GBP"â€¿"USDC"â€¿"UST"â€¿"DAI"â€¿"ETH"
	pairs â† Â¯5â†“Â¨2 âŠË˜ data
	tqposâ† â‰ qassets (+Â´âˆ˜/âˆ˜(Â¯1âŠ¸âŠ‘ Ã— âŠ¢)âˆ˜â·)âŒœ pairs
	qpos â† âŒˆËË˜ tqpos 
	quoteâ† â¥Š((/âŸœqassets)Ë˜(0âŠ¸â‰¢)Â¨) tqpos 
	base â† qpos	â†‘Â¨ pairs
	avgPriceâ†â€¢parsefloatÂ¨ 7âŠË˜data
	executedâ†â€¢parsefloatÂ¨ 6âŠË˜data
	calcTotal â† avgPrice Ã— executed
	isideâˆ¾â‰> executed (<âˆ˜â‰)Ë˜ calcTotal
	receivedâ€¿spent â† <Ë˜â‰>(iside â‰¢Â¨ 1) âŒ½Â¨ executed (<âˆ˜â‰)Ë˜ calcTotal
	# apply 0.1% manually
	#fee â† 0.001 Ã— received
	#feeU â† (iside â‰¢Â¨ 1) âŠ‘Â¨ base (<âˆ˜â‰)Ë˜ quote
	("exchange"â€¿"ts"â€¿"iside"â€¿"base"â€¿"quote"â€¿"received"â€¿"spent") âˆ¾ (<"bitget") âˆ¾Ë˜ â‰[tscol, iside, base, quote, received, spent]
}
#5â†‘ BitgetTra 0 
# TODO: add Kraken
#############################################
#  Kraken
#############################################

#############################################
### Consolidate all trades

# Load consolidated transactions ordered by timestamp
â‰¢ transâ†  ((â‹1âŠ¸âŠË˜)âŠâŠ¢) (âŠË˜ âˆ¾Ë˜ ((10âŠ¸â†‘âŠ¸âˆ¾âŸœ" "âŠ¸âˆ¾âŸœ(8âŠ¸â†‘ 11âŠ¸â†“))Â¨ 1âŠ¸âŠË˜) âˆ¾Ë˜ 2âŠ¸â†“Ë˜) âˆ¾Â´ BinanceTraâ€¿PhemexTraâ€¿KucoinTraâ€¿BitgetTraâ€¿CoinbaseProTra { 1â†“ ğ• ğ•©}Â¨ <0

# convert DAI USDC BUSD to USDT
qquotesâ† â·cquote â† â¥Š((Â¬âˆŠâŸœ"DAI"â€¿"USDC"â€¿"BUSD") âŠË˜ ((<"USDT")âŠ¸âˆ¾Ë˜)) â¥ŠË˜4âŠË˜ trans
# take base and quote amounts according to side
Â¯10â†‘Â¨ bamntâ€¿qamnt â† <Ë˜â‰ ((1âŠ¸â‰¢Â¨ 2âŠ¸âŠË˜) âŒ½Ë˜ (Â¯2âŠ¸â†‘Ë˜)) trans
10â†‘ httsâ† FromTSÂ¨ hdtsâ† (âˆ¾âŸœ0â€¿0 4âŠ¸â†‘)Â¨ dtsâ† (ToNums  âŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸ReplaceAll)Â¨ 1âŠË˜ trans


FillMissing â† { 
	tsâ€¿pâ† <Ë˜â‰0â€¿Â¯1âŠ¸âŠË˜ğ•©
	ttake â† (âˆ¾âŸœ1âˆ˜Ã·âŸœğ•¨âˆ˜(1âŠ¸â†“-âŸœÂ»))ts 
	(âˆ¾Â´(ts) + ğ•¨ Ã— â†•Â¨ ttake) â‰Ë˜ (ttake / p)
} 

lquotes â† ((Â¬âˆŠâŸœ"GBP"â€¿"USDT")âŠ¸/) qquotes
# Loading quote candlesticks except USDT
LoadQ â† { lquotes â† ğ•©
	qfilesâ† (âŠ¢âˆ¾âŸœ"_USDT-1h.json")Â¨ (<"/media/mu6mula/Data/Crypto-Data-Feed/freq-user-data/data/binance/") âˆ¾Â¨ lquotes
	qticks â† (((Ã·âŸœ1000âˆ˜âŠË˜) âˆ¾Ë˜ ((+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))âˆ˜>âˆ˜JParseâˆ˜â€¢FChars)Â¨ qfiles
	gbp â† ((FromTSÂ¨âŠË˜)âˆ¾Ë˜( (+Â´Ã·â‰ )Ë˜1â€¿2â€¿3â€¿4âŠ¸âŠË˜))  ((âˆ¾âŸœ0âˆ˜(ToNumsâŸ¨"-"âŸ©â€¿âŸ¨" "âŸ©âŠ¸ReplaceAll)Â¨âˆ˜âŠË˜)âˆ¾Ë˜(â€¢ParseFloatÂ¨Ë˜ (Â¯1â†“Ë˜1âŠ¸â†“Ë˜)))>Â¯1â†“76000â†“csv.Splitâ€¢FChars"GBPUSD60.csv"
	3â†‘Â¨ qgticks â†  qticks  âˆ¾ <gbp
	lgquotes â† lquotesâˆ¾<"GBP"
	lgquotesâ€¿qgticks
}
âŠ‘ gquotesâ€¿gticks â† LoadQ lquotes
usmaskâ†(âˆŠâŸœâŸ¨"USDT"âŸ©) qquotes 
nuquotes â† (Â¬usmask)/ qquotes 
>2â†‘Â¨orticks â† (gquotes âŠ nuquotes) âŠ 3600âŠ¸FillMissingÂ¨ gticks 
â‰¢Â¨gtrts â† ((âŠcquote)âŠ”htts) 
### missing quote tickers
+Â´Â¨ (âŠË˜Â¨orticks) (Â¬âŠ¢âˆŠâŠ£)Â¨ (Â¬usmask) / gtrts
+Â´Â¨ orticks ( ( (âŠË˜âŠ£)âŠâŠ¢) â‰¥ (â‰ âŠ£))Â¨ (Â¬usmask)/gtrts

## Ticker quote price in USDT per transaction (grouped by cquotes)
2â†‘Â¨ gusdp â† (orticks (((âŠË˜âŠ£)âŠâŠ¢)âŠ(1âŠ¸âŠË˜âŠ£))Â¨(Â¬usmask)/gtrts) âˆ¾ <((â‰ (âŠ‘/usmask)âŠ‘gtrts)â¥Š1)
itrans â† (qquotes âŠ (âˆ¾âŸœ(<"USDT")) âŠ¢ (Â¬usmask) / qquotes) 

"transactions.csv" â€¢FLines csv.JoinL ((2âŠ¸â†‘Ë˜) âˆ¾Ë˜ (â€¢FmtÂ¨ 2âŠ¸âŠË˜) âˆ¾Ë˜ 3â€¿4âŠ¸âŠË˜ âˆ¾Ë˜ (â€¢FmtÂ¨5âŠ¸â†“Ë˜))  âˆ¾Â´ gusdp (âˆ¾ËœË˜)Â¨ itrans âŠ (grtrans â† (âŠcquote)âŠ”trans)
csv.Join 2â€¿3â¥Šâ†‘"BQNcs"
>2â†‘Â¨nugtrans â† (Â¬usmask) / grtrans







3â†‘Â¨ orticks ((âŠË˜âŠ£))Â¨ (Â¬usmask) / gtrts
â‰¢ Â¯1âŠ‘ gticks
ftsâ€¿lts â† 0â€¿Â¯1âŠ htts # first and last timestamp of transactions
# first and last timestamp per quote unit
(âŠË˜ 0â€¿Â¯1âŠ¸âŠ)Â¨ gticks
âŠË˜Â¨ gticks
10â†‘ trans
>1â†‘Â¨  ((âŠ4âŠ¸âŠË˜)âŠ¸âŠ”) trans
â‰¢Â¨ gticks
â‰¢Â¨(<trans) /Â¨Ëœ (<htts) (Â¬âˆŠ)Â¨ âŠË˜Â¨ gticks 


# Totals and bags
# Calculate totals by asset
15â†‘ inFlows â† (2â†‘Ë˜ trans) âˆ¾Ë˜ 1 âˆ¾Ë˜ ((1â‰¢Â¨2âŠË˜trans) âŠ‘Â¨ <Ë˜â‰3â€¿4 âŠ â‰trans) âˆ¾Ë˜ 5âŠË˜trans
15â†‘ outFlows â† (2â†‘Ë˜ trans) âˆ¾Ë˜ Â¯1 âˆ¾Ë˜ ((1â‰¡Â¨2âŠË˜trans) âŠ‘Â¨ <Ë˜â‰3â€¿4 âŠ â‰trans) âˆ¾Ë˜ -6âŠË˜trans
15â†‘ inOutFlows â† inFlows âˆ¾ outFlows
â‰¢inOutFlows
3â†‘ assetsH â† â· 3âŠË˜ inOutFlows 
iassets â† â‹assetsH
assets â† iassets âŠ assetsH
assets (âŠ‘âŠ’) <"BTC"
5â†‘ 12âŠ‘ aflows â†  ((â‹1âŠ¸âŠË˜)âŠâŠ¢)Â¨ iassets âŠ (âŠ(3âŠ¸âŠ)Ë˜)âŠ¸âŠ” inOutFlows 
5â†‘ 10600â†“ 12âŠ‘ (âˆ¾Ë˜âŸœ(+`Â¯1âŠ¸âŠË˜))Â¨ aflows
#>3â†‘ 13â†‘Â¨ sigFlows â† ( (Ã—Â´Â¨ <Ë˜))Â¨ (2â€¿4âŠ¸âŠË˜)Â¨ aflows 
#1âŠ¸âŠÂ¨aflows
13â†‘ finalAmounts â† (+Â´ Â¯1âŠ¸âŠË˜) Â¨ aflows 
#>3â†‘ 9â†‘Â¨ cumFlows â†  +`Â¨ sigFlows 
# 12âŠ‘ aflows âˆ¾Ë˜Â¨ cumFlows
 assets âˆ¾Ë˜ finalAmounts

(<Â¯2âŠ¸â†‘)Ë˜ trans




